<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: "en" }}">

  {%- include head.html -%}

  <body>

    {%- include header.html -%}

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        {{ content }}
      </div>
    </main>

    {%- include footer.html -%}

    <!-- Mermaid Diagram Support -->
    <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        if (typeof mermaid === 'undefined') {
          console.error('Mermaid library not loaded!');
          return;
        }
        
        mermaid.initialize({
          startOnLoad: false,
          theme: 'default',
          flowchart: {
            useMaxWidth: true,
            htmlLabels: true
          },
          sequence: {
            useMaxWidth: true
          },
          gantt: {
            useMaxWidth: true
          }
        });
        
        // Find all code blocks that start with mermaid syntax
        var allCodeBlocks = document.querySelectorAll('pre code');
        
        allCodeBlocks.forEach(function(block) {
          var code = block.textContent || block.innerText;
          var trimmedCode = code.trim();
          
          // Check if this looks like a mermaid diagram
          if (isMermaidCode(trimmedCode)) {
            processMermaidBlock(block);
          }
        });
        
        function isMermaidCode(code) {
          var mermaidKeywords = [
            'graph', 'sequenceDiagram', 'classDiagram', 'gantt', 
            'stateDiagram', 'erDiagram', 'journey', 'gitgraph',
            'pie', 'quadrantChart', 'requirement', 'mindmap', 'timeline'
          ];
          
          return mermaidKeywords.some(function(keyword) {
            return code.startsWith(keyword);
          });
        }
        
        function processMermaidBlock(block) {
          var code = block.textContent || block.innerText;
          
          // Create wrapper container for clickable functionality
          var wrapperDiv = document.createElement('div');
          wrapperDiv.className = 'mermaid-wrapper';
          
          // Store original code as data attribute for later use
          wrapperDiv.setAttribute('data-mermaid-code', code);
          
          // Create mermaid diagram container
          var diagramDiv = document.createElement('div');
          diagramDiv.className = 'mermaid';
          diagramDiv.textContent = code;
          
          // Add click handler to wrapper
          wrapperDiv.appendChild(diagramDiv);
          
          // Insert the wrapper after the code block
          var preElement = block.parentNode;
          preElement.parentNode.insertBefore(wrapperDiv, preElement.nextSibling);
          
          // Hide the original code block
          preElement.style.display = 'none';
        }
        
        // Initialize mermaid after processing all blocks
        var mermaidElements = document.querySelectorAll('.mermaid');
        if (mermaidElements.length > 0) {
          mermaid.init(undefined, mermaidElements);
          
          // Wait for mermaid to render, then setup click handlers
          // Use a small delay to ensure SVG is rendered
          setTimeout(function() {
            setupMermaidClickHandlers();
          }, 100);
        }
        
        function setupMermaidClickHandlers() {
          var wrappers = document.querySelectorAll('.mermaid-wrapper');
          
          wrappers.forEach(function(wrapper) {
            var diagram = wrapper.querySelector('.mermaid');
            if (!diagram) return;
            
            // Make wrapper clickable
            wrapper.style.cursor = 'pointer';
            wrapper.title = 'Click to view fullscreen';
            
            wrapper.addEventListener('click', function(e) {
              // Allow clicking anywhere on the diagram to open fullscreen
              var mermaidCode = wrapper.getAttribute('data-mermaid-code');
              openMermaidFullscreen(mermaidCode);
            });
          });
        }
        
        function openMermaidFullscreen(mermaidCode) {
          // Create modal overlay
          var modal = document.createElement('div');
          modal.className = 'mermaid-modal';
          modal.setAttribute('role', 'dialog');
          modal.setAttribute('aria-modal', 'true');
          modal.setAttribute('aria-label', 'Mermaid diagram fullscreen view');
          
          // Set inline styles to ensure proper positioning
          modal.style.cssText = 'position:fixed!important;top:0!important;left:0!important;right:0!important;bottom:0!important;width:100vw!important;height:100vh!important;z-index:10000!important;background-color:#ffffff!important;margin:0!important;padding:0!important;overflow:hidden!important;';
          
          // Create modal content
          var modalContent = document.createElement('div');
          modalContent.className = 'mermaid-modal-content';
          modalContent.style.cssText = 'position:absolute!important;top:0!important;left:0!important;right:0!important;bottom:0!important;width:100vw!important;height:100vh!important;background-color:#ffffff!important;padding:60px 20px 20px 20px!important;overflow:auto!important;box-sizing:border-box!important;margin:0!important;display:flex!important;align-items:center!important;justify-content:center!important;';
          
          // Create new diagram container for modal
          var diagramDiv = document.createElement('div');
          diagramDiv.className = 'mermaid mermaid-fullscreen';
          diagramDiv.textContent = mermaidCode;
          
          // Create close button
          var closeButton = document.createElement('button');
          closeButton.className = 'mermaid-modal-close';
          closeButton.innerHTML = 'Close (ESC)';
          closeButton.setAttribute('aria-label', 'Close fullscreen view');
          closeButton.setAttribute('title', 'Close (ESC)');
          
          // Apply inline styles to ensure positioning
          closeButton.style.cssText = 'position:fixed!important;top:20px!important;left:50%!important;transform:translateX(-50%)!important;z-index:10001!important;';
          
          modalContent.appendChild(closeButton);
          modalContent.appendChild(diagramDiv);
          modal.appendChild(modalContent);
          
          // Prevent any scroll jumps - save current scroll position
          var scrollY = window.scrollY;
          
          // Add to body (at the end to ensure it's on top)
          document.body.appendChild(modal);
          document.body.style.overflow = 'hidden'; // Prevent background scrolling
          document.body.style.position = 'fixed';
          document.body.style.top = '-' + scrollY + 'px';
          document.body.style.width = '90%';
          
          // Render the mermaid diagram in the modal
          // Use a small delay to ensure DOM is ready, then render
          setTimeout(function() {
            try {
              // Try using mermaid.run if available (v10+)
              if (typeof mermaid.run === 'function') {
                mermaid.run({
                  nodes: [diagramDiv]
                }).then(function() {
                  scaleSvgToFit(diagramDiv);
                  closeButton.focus();
                }).catch(function(err) {
                  console.error('Error rendering mermaid:', err);
                  closeButton.focus();
                });
              } else {
                // Fallback for older versions
                mermaid.init(undefined, [diagramDiv], function() {
                  scaleSvgToFit(diagramDiv);
                  closeButton.focus();
                });
              }
            } catch (err) {
              console.error('Error rendering mermaid diagram:', err);
              closeButton.focus();
            }
          }, 10);
          
          function scaleSvgToFit(container) {
            var svg = container.querySelector('svg');
            if (!svg) return;
            
            // Get the original SVG dimensions from various sources
            var svgRect = svg.getBoundingClientRect();
            var svgWidth = svgRect.width;
            var svgHeight = svgRect.height;
            
            // Try viewBox if bounding rect is too small
            if (svg.viewBox && svg.viewBox.baseVal) {
              var vb = svg.viewBox.baseVal;
              if (vb.width > svgWidth) svgWidth = vb.width;
              if (vb.height > svgHeight) svgHeight = vb.height;
            }
            
            // Fallback to attributes
            if (!svgWidth || svgWidth < 100) {
              svgWidth = parseFloat(svg.getAttribute('width')) || 400;
            }
            if (!svgHeight || svgHeight < 100) {
              svgHeight = parseFloat(svg.getAttribute('height')) || 300;
            }
            
            // Available space (viewport minus padding for close button)
            var availableWidth = window.innerWidth - 80;
            var availableHeight = window.innerHeight - 120;
            
            // Calculate scale to fit while maintaining aspect ratio
            var scaleX = availableWidth / svgWidth;
            var scaleY = availableHeight / svgHeight;
            var scale = Math.min(scaleX, scaleY);
            
            // Ensure reasonable scaling
            scale = Math.max(scale, 1);   // Minimum 1x (no downscaling)
            scale = Math.min(scale, 2.5); // Maximum 2.5x scale
            
            console.log('SVG scaling:', {
              originalWidth: svgWidth,
              originalHeight: svgHeight,
              availableWidth: availableWidth,
              availableHeight: availableHeight,
              scale: scale
            });
            
            // Apply the scale using transform
            svg.style.transform = 'scale(' + scale + ')';
            svg.style.transformOrigin = 'center center';
            
            // Also set explicit dimensions on the container to prevent layout issues
            container.style.width = (svgWidth * scale) + 'px';
            container.style.height = (svgHeight * scale) + 'px';
          }
          
          // Close handlers
          function closeModal() {
            if (modal && modal.parentNode) {
              document.body.removeChild(modal);
            }
            // Restore scrolling and scroll position
            var scrollY = document.body.style.top;
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.width = '';
            document.body.style.overflow = '';
            if (scrollY) {
              window.scrollTo(0, parseInt(scrollY || '0') * -1);
            }
            document.removeEventListener('keydown', handleEsc);
          }
          
          function handleEsc(e) {
            if (e.key === 'Escape' || e.keyCode === 27) {
              closeModal();
            }
          }
          
          closeButton.addEventListener('click', function(e) {
            e.stopPropagation();
            closeModal();
          });
          
          modal.addEventListener('click', function(e) {
            // Close if clicking anywhere except on the diagram or close button
            if (e.target === modal || e.target === modalContent || 
                (e.target !== closeButton && !modalContent.querySelector('.mermaid-fullscreen').contains(e.target))) {
              closeModal();
            }
          });
          
          // Close on ESC key
          document.addEventListener('keydown', handleEsc);
        }
      });
    </script>

  </body>

</html> 